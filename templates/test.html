{% extends "base.html" %}
{% block title %}Test in Progress - GRE Practiser{% endblock %}

{% block extra_styles %}
<style>
    .test-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .timer-bar {
        position: sticky;
        top: 80px;
        /* Below header */
        background: var(--bg-surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        z-index: 40;
        box-shadow: var(--shadow-sm);
    }

    .timer-display {
        font-family: var(--font-sans);
        font-variant-numeric: tabular-nums;
        font-weight: 600;
        font-size: 1.25rem;
        color: var(--text-primary);
    }

    .timer-display.warning {
        color: #DC2626;
        /* Red 600 */
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        50% {
            opacity: 0.5;
        }
    }

    .question-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        padding: 3rem;
        box-shadow: var(--shadow-sm);
    }

    .question-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }

    .question-number {
        font-family: var(--font-serif);
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-secondary);
    }

    .badges {
        display: flex;
        gap: 0.5rem;
    }

    .badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        background: var(--bg-subtle);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .question-text {
        font-size: 1.15rem;
        line-height: 1.8;
        margin-bottom: 2.5rem;
        color: var(--text-primary);
    }

    .options-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .option-label {
        display: flex;
        align-items: center;
        padding: 1.25rem;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .option-label:hover {
        background-color: var(--bg-subtle);
        border-color: var(--text-tertiary);
    }

    .option-label.selected {
        background-color: #FFF7ED;
        /* Orange 50 */
        border-color: var(--brand-gold);
        box-shadow: 0 0 0 1px var(--brand-gold);
    }

    .option-input {
        margin-right: 1rem;
        width: 1.25rem;
        height: 1.25rem;
        accent-color: var(--brand-gold);
    }

    .qc-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
        background: var(--bg-subtle);
        padding: 2rem;
        border-radius: var(--radius-md);
    }

    .qc-col {
        text-align: center;
    }

    .qc-label {
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-size: 0.9rem;
    }

    .qc-value {
        font-size: 1.25rem;
        font-family: var(--font-serif);
    }

    .nav-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-light);
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <div class="timer-bar">
        <span class="text-sm text-muted font-medium">Time Remaining</span>
        <div class="timer-display" id="timer">{{ time_limit }}:00</div>
    </div>

    <form id="test-form" action="/submit_test" method="POST">
        <div class="question-card">
            <div class="question-meta">
                <span class="question-number">Question {{ q_idx + 1 }} <span class="text-muted"
                        style="font-weight: 400; font-size: 1rem;">of {{ total_questions }}</span></span>
                <div class="badges">
                    <span class="badge">{{ question.type|upper }}</span>
                    <span class="badge">{{ question.difficulty }}</span>
                </div>
            </div>

            <div class="question-text">{{ question.question }}</div>

            {% if question.type == 'qc' %}
            <div class="qc-grid">
                <div class="qc-col">
                    <div class="qc-label">Quantity A</div>
                    <div class="qc-value">{{ question.quantity_a }}</div>
                </div>
                <div class="qc-col">
                    <div class="qc-label">Quantity B</div>
                    <div class="qc-value">{{ question.quantity_b }}</div>
                </div>
            </div>
            <div class="options-grid">
                {% set qc_options = ['Quantity A is greater', 'Quantity B is greater', 'The two quantities are equal',
                'The relationship cannot be determined from the information given'] %}
                {% for option in qc_options %}
                <label class="option-label {% if answer == option %}selected{% endif %}">
                    <input type="radio" class="option-input" name="q{{ question.id }}" value="{{ option }}" {% if
                        answer==option %}checked{% endif %}
                        onchange="saveAnswer('{{ question.id }}', this.value); document.querySelectorAll('.option-label').forEach(o => o.classList.remove('selected')); this.parentElement.classList.add('selected');">
                    <span>{{ option }}</span>
                </label>
                {% endfor %}
            </div>

            {% elif question.type == 'ma' %}
            <div class="alert alert-info mb-4">
                Select all that apply
            </div>
            <div class="options-grid">
                {% for option in question.options %}
                <label class="option-label {% if answer and option in answer %}selected{% endif %}">
                    <input type="checkbox" class="option-input" name="q{{ question.id }}" value="{{ option }}" {% if
                        answer and option in answer %}checked{% endif %}
                        onchange="saveMultipleAnswer('{{ question.id }}'); this.parentElement.classList.toggle('selected', this.checked);">
                    <span>{{ option }}</span>
                </label>
                {% endfor %}
            </div>

            {% elif question.type == 'numeric' %}
            <div class="alert alert-info mb-4">
                Enter your answer as a number
            </div>
            <input type="text" class="form-input" style="max-width: 300px; font-size: 1.25rem;"
                name="q{{ question.id }}" value="{{ answer or '' }}" placeholder="Your answer..."
                onchange="saveAnswer('{{ question.id }}', this.value)">

            {% else %} {# mc type #}
            <div class="options-grid">
                {% for option in question.options %}
                <label class="option-label {% if answer == option %}selected{% endif %}">
                    <input type="radio" class="option-input" name="q{{ question.id }}" value="{{ option }}" {% if
                        answer==option %}checked{% endif %}
                        onchange="saveAnswer('{{ question.id }}', this.value); document.querySelectorAll('.option-label').forEach(o => o.classList.remove('selected')); this.parentElement.classList.add('selected');">
                    <span>{{ option }}</span>
                </label>
                {% endfor %}
            </div>
            {% endif %}

            <div class="nav-bar">
                <div>
                    {% if q_idx > 0 %}
                    <a href="{{ url_for('test', q_idx=q_idx-1) }}" class="btn btn-secondary">Previous</a>
                    {% endif %}
                </div>

                <div>
                    {% if q_idx < total_questions - 1 %} <a href="{{ url_for('test', q_idx=q_idx+1) }}"
                        class="btn btn-primary">Next Question</a>
                        {% else %}
                        <button type="button" class="btn btn-primary" onclick="confirmSubmit()">Submit Test</button>
                        {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Clear timer if new test started
    {% if session.get('clear_gre_timer') %}
    sessionStorage.removeItem('gre_timer_remaining');
    {% set _ = session.pop('clear_gre_timer', None) %}
    {% endif %}

    // Use server-side remaining time as the source of truth
    let timeRemaining = {{ remaining_seconds }};

    // Update session storage to sync with server time (optional, but good for consistency)
    sessionStorage.setItem('gre_timer_remaining', timeRemaining);

    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timerElement = document.getElementById('timer');
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (timeRemaining <= 300) {
            timerElement.classList.add('warning');
        }

        if (timeRemaining <= 0) {
            sessionStorage.removeItem('gre_timer_remaining');
            autoSubmit();
        } else {
            timeRemaining--;
            sessionStorage.setItem('gre_timer_remaining', timeRemaining);
            setTimeout(updateTimer, 1000);
        }
    }

    const answers = {};

    function saveAnswer(questionId, answer) {
        answers[questionId] = answer;
        fetch('/submit_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_id: parseInt(questionId), answer: answer })
        });
    }

    function saveMultipleAnswer(questionId) {
        const checkboxes = document.querySelectorAll(`input[name="q${questionId}"]:checked`);
        const selectedAnswers = Array.from(checkboxes).map(cb => cb.value);
        answers[questionId] = selectedAnswers;
        fetch('/submit_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_id: parseInt(questionId), answer: selectedAnswers })
        });
    }

    function confirmSubmit() {
        if (confirm('Are you sure you want to submit your test?')) {
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            document.getElementById('test-form').submit();
        }
    }

    function autoSubmit() {
        alert('Time is up! Your test will be submitted automatically.');
        window.removeEventListener('beforeunload', beforeUnloadHandler);
        document.getElementById('test-form').submit();
    }

    function beforeUnloadHandler(e) {
        e.preventDefault();
        e.returnValue = '';
    }

    updateTimer();
    window.addEventListener('beforeunload', beforeUnloadHandler);

    // Only warn on submit, not on navigation
    document.querySelectorAll('a, .btn, .btn-secondary').forEach(btn => {
        btn.addEventListener('click', function (e) {
            const isSubmit = this.getAttribute('onclick') && this.getAttribute('onclick').includes('confirmSubmit');
            const isNav = this.href && this.href.includes('/test/');

            if (isSubmit || isNav) {
                window.removeEventListener('beforeunload', beforeUnloadHandler);
            }
        });
    });
</script>
{% endblock %}