{% extends "base.html" %}
{% block title %}Test Results - GRE Practiser{% endblock %}

{% block extra_styles %}
<style>
    .results-header {
        text-align: center;
        margin-bottom: 4rem;
        padding: 3rem;
        background: var(--bg-surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
    }

    .score-display {
        font-family: var(--font-serif);
        font-size: 4rem;
        font-weight: 700;
        line-height: 1;
        margin: 1rem 0;
        color: var(--text-primary);
    }

    .score-label {
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .review-section {
        margin-top: 4rem;
    }

    .review-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 1.5rem;
    }

    .review-card.correct {
        border-left: 4px solid #166534;
    }

    .review-card.incorrect {
        border-left: 4px solid #991B1B;
    }

    .review-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .review-question {
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
    }

    .answer-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        background: var(--bg-subtle);
        padding: 1.5rem;
        border-radius: var(--radius-md);
        font-size: 0.95rem;
    }

    .explanation {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-light);
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .chart-container {
        height: 200px;
        display: flex;
        align-items: flex-end;
        gap: 4px;
        margin-top: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }

    .chart-bar {
        flex: 1;
        background: var(--text-tertiary);
        border-radius: 2px 2px 0 0;
        transition: height 0.5s ease;
        position: relative;
    }

    .chart-bar:hover {
        background: var(--text-primary);
    }

    .chart-bar[data-current="true"] {
        background: var(--brand-gold);
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px;">
    <div class="results-header">
        <div class="score-label">Accuracy</div>
        <div class="score-display">{{ "%.0f"|format(results.accuracy) }}%</div>
        <p class="text-muted">
            You answered {{ results.correct }} out of {{ results.total }} questions correctly.
        </p>

        <div class="flex justify-center gap-4 mt-8">
            <a href="{{ url_for('index') }}" class="btn btn-primary">Take Another Test</a>
            <a href="{{ url_for('profile') }}" class="btn btn-secondary">View Profile</a>
        </div>
    </div>

    {% if history %}
    <div class="mb-8">
        <h3 class="mb-4">Performance Trend</h3>
        <div class="chart-container">
            {% for entry in history[-20:] %}
            <div class="chart-bar" style="height: {{ entry.accuracy }}%;" data-current="{{ loop.last }}"
                title="Date: {{ entry.date }} | Score: {{ entry.accuracy }}%">
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="review-section">
        <h3 class="mb-4">Detailed Review</h3>
        {% for detail in results.details %}
        <div class="review-card {{ 'correct' if detail.correct else 'incorrect' }}">
            <div class="review-meta">
                <span class="font-bold">Question {{ loop.index }}</span>
                <span>{{ detail.question.type|upper }} â€¢ {{ detail.question.difficulty }}</span>
            </div>

            <div class="review-question">{{ detail.question.question }}</div>

            {% if detail.question.type == 'qc' %}
            <div class="grid grid-cols-2 gap-4 mb-4 p-4 bg-gray-50 rounded">
                <div><strong>Qty A:</strong> {{ detail.question.quantity_a }}</div>
                <div><strong>Qty B:</strong> {{ detail.question.quantity_b }}</div>
            </div>
            {% endif %}

            <div class="answer-comparison">
                <div>
                    <div class="text-sm text-muted mb-1">Your Answer</div>
                    <div class="{{ 'text-green-700' if detail.correct else 'text-red-700' }} font-medium">
                        {% if detail.user_answer %}
                        {% if detail.question.type == 'ma' and detail.user_answer is sequence %}
                        {{ detail.user_answer|join(', ') }}
                        {% else %}
                        {{ detail.user_answer }}
                        {% endif %}
                        {% else %}
                        <span class="text-muted italic">Not answered</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="text-sm text-muted mb-1">Correct Answer</div>
                    <div class="font-medium">
                        {% if detail.question.type == 'mc' %}
                        {{ detail.question.options[detail.correct_answer] }}
                        {% elif detail.question.type == 'qc' %}
                        {% set qc_opts = ["Quantity A is greater", "Quantity B is greater", "The two quantities are
                        equal", "The relationship cannot be determined"] %}
                        {{ qc_opts[detail.correct_answer] }}
                        {% elif detail.question.type == 'ma' %}
                        {% set correct_indices = detail.correct_answer if detail.correct_answer is sequence else
                        [detail.correct_answer] %}
                        {% set correct_texts = [] %}
                        {% for idx in correct_indices %}
                        {% set _ = correct_texts.append(detail.question.options[idx]) %}
                        {% endfor %}
                        {{ correct_texts|join(', ') }}
                        {% else %}
                        {{ detail.correct_answer }}
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if detail.question.explanation %}
            <div class="explanation">
                <strong>Explanation:</strong> {{ detail.question.explanation }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}